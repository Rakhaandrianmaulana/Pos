<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iot Lana Project v.1.0 (Robust)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0c0a09; color: #e7e5e4; }
        .card { background-color: #1c1917; border: 1px solid #44403c; border-radius: 0.75rem; padding: 1.5rem; }
        .action-button { background: linear-gradient(90deg, #3b82f6, #6366f1); transition: all 0.3s ease; box-shadow: 0 4px 15px 0 rgba(99, 102, 241, 0.5); }
        .action-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px 0 rgba(99, 102, 241, 0.6); }
        .action-button:disabled { background: #57534e; color: #a8a29e; cursor: not-allowed; box-shadow: none; opacity: 0.6; }
        .spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 3px solid #6366f1; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(12, 10, 9, 0.8); display: flex; justify-content: center; align-items: center; z-index: 50; backdrop-filter: blur(8px); }
        .modal-content { background-color: #1c1917; padding: 2rem; border-radius: 0.75rem; max-width: 500px; width: 90%; border: 1px solid #57534e; }
        .progress-bar-container { background-color: #3f3f46; border-radius: 9999px; }
        .progress-bar { background: linear-gradient(90deg, #16a34a, #22c55e); transition: width 0.5s ease-in-out; }
    </style>
</head>
<body class="antialiased">

    <!-- Consent Modal -->
    <div id="consentModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4 text-white">Selamat Datang di Lana v.1.0</h2>
            <p class="text-stone-300 mb-6">Aplikasi ini akan meminta izin untuk fitur lokal (GPS, Bluetooth) dan mencoba terhubung ke server untuk monitoring. Fitur lokal akan tetap berfungsi jika server tidak tersedia.</p>
            <div class="flex justify-end gap-4">
                <button id="declineButton" class="px-5 py-2 rounded-md text-stone-300 bg-stone-600 hover:bg-stone-700 font-semibold">Tolak</button>
                <button id="agreeButton" class="px-5 py-2 rounded-md text-white font-semibold bg-blue-600 hover:bg-blue-700">Setuju & Lanjutkan</button>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-extrabold text-white mb-2">IoT Lana Dashboard <span class="text-lg align-middle font-mono bg-blue-600 text-white rounded-md px-2 py-1">v.1.0</span></h1>
            <p class="text-stone-400">Dasbor Robust dengan Arsitektur Terpisah</p>
        </header>

        <div id="app-content" class="hidden space-y-8">
            <!-- System Monitoring Card -->
            <div class="card">
                <h2 class="text-xl font-semibold text-white mb-4"><i class="fas fa-shield-heart mr-3 text-purple-400"></i>Status Sistem & Monitoring</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-8">
                    <div>
                        <div class="text-stone-400 text-sm mb-2">Pengguna Online</div>
                        <div class="text-4xl font-bold text-white mb-2" id="totalUserCount">...</div>
                        <div class="flex justify-around text-center text-sm">
                            <div><span class="text-green-400" id="realUserCount">...</span><br><span class="text-stone-500">Nyata</span></div>
                            <div><span class="text-cyan-400" id="botUserCount">...</span><br><span class="text-stone-500">Bot</span></div>
                        </div>
                    </div>
                    <div>
                         <div class="text-stone-400 text-sm mb-2 flex justify-between">
                            <span>Penggunaan Memori Harian</span>
                            <span id="memoryUsageText" class="font-mono">0 MB / 1.0 TB</span>
                        </div>
                        <div class="progress-bar-container w-full h-4 overflow-hidden">
                            <div id="memoryProgressBar" class="progress-bar h-full" style="width: 0%;"></div>
                        </div>
                         <p id="memoryWarning" class="text-xs text-yellow-500 mt-2 hidden"><i class="fas fa-exclamation-triangle mr-1"></i>Performa akan menurun setelah kuota habis.</p>
                    </div>
                </div>
                 <div id="systemStatus" class="text-xs text-stone-500 mt-4 pt-4 border-t border-stone-600 flex items-center"><div class="spinner mr-2"></div><span>Mencoba terhubung ke layanan monitoring...</span></div>
            </div>

            <!-- Functional Cards Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="card">
                    <h2 class="text-xl font-semibold text-white mb-4 flex items-center"><i class="fas fa-location-arrow text-green-400 mr-3"></i>Lokasi Real-Time</h2>
                    <div id="locationContent" class="hidden grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                        <div><div class="text-stone-400 text-sm">Latitude</div><div id="latitude" class="text-lg font-bold">-</div></div>
                        <div><div class="text-stone-400 text-sm">Longitude</div><div id="longitude" class="text-lg font-bold">-</div></div>
                        <div><div class="text-stone-400 text-sm">Akurasi</div><div id="accuracy" class="text-lg font-bold">-</div></div>
                        <div class="sm:col-span-3 mt-4">
                            <a id="mapLink" href="#" target="_blank" rel="noopener noreferrer" class="action-button inline-block w-full sm:w-auto text-white font-semibold py-2 px-6 rounded-lg text-center"><i class="fas fa-map-marker-alt mr-2"></i>Buka di Peta</a>
                        </div>
                    </div>
                    <div id="locationPlaceholder" class="flex items-center justify-center py-4"><div class="spinner"></div><span class="ml-3 text-stone-300">Meminta izin lokasi...</span></div>
                </div>
                <div class="card">
                    <h2 class="text-xl font-semibold text-white mb-4">Analisis Koneksi Aktif</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center"><div class="text-stone-400 text-sm">Tipe</div><div class="text-xl font-bold flex items-center justify-center gap-2"><i id="connectionIcon" class="fas fa-wifi"></i><span id="connectionType">N/A</span></div></div>
                        <div class="text-center"><div class="text-stone-400 text-sm">Kualitas</div><div id="effectiveType" class="text-xl font-bold text-cyan-400">N/A</div></div>
                        <div class="text-center"><div class="text-stone-400 text-sm">Downlink</div><div class="text-xl font-bold"><span id="downlink">-</span> <span class="text-base text-stone-400">Mbps</span></div></div>
                        <div class="text-center"><div class="text-stone-400 text-sm">Ping</div><div id="pingResult" class="text-xl font-bold text-amber-400">- ms</div></div>
                    </div>
                     <button id="pingButton" class="w-full mt-4 bg-stone-600 hover:bg-stone-500 text-white font-semibold py-2 px-4 rounded-lg text-sm action-button"><i class="fas fa-play mr-1"></i> Uji Ping (Biaya: 25MB)</button>
                </div>
                <div class="card">
                    <h2 class="text-xl font-semibold text-white mb-4"><i class="fab fa-bluetooth-b text-blue-400 mr-3"></i>Pemindai Bluetooth</h2>
                    <button id="scanBluetoothButton" class="action-button text-white font-bold py-2 px-5 rounded-lg"><i class="fas fa-search mr-2"></i>Cari Perangkat (Biaya: 150MB)</button>
                    <ul id="bluetoothList" class="mt-4 space-y-2"></ul>
                </div>
                <div class="card">
                     <h2 class="text-xl font-semibold text-white mb-4"><i class="fas fa-tag text-indigo-400 mr-3"></i>Pembaca Tag NFC</h2>
                     <button id="scanNfcButton" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-5 rounded-lg action-button"><i class="fas fa-search-plus mr-2"></i>Pindai Tag NFC (Biaya: 75MB)</button>
                     <div id="nfcStatus" class="mt-4 text-center text-stone-400 hidden"></div>
                     <div id="nfcContent" class="mt-4 hidden break-words p-3 bg-stone-800 rounded-lg"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Element References ---
        const consentModal = document.getElementById('consentModal'), agreeButton = document.getElementById('agreeButton'), declineButton = document.getElementById('declineButton'), appContent = document.getElementById('app-content');
        const totalUserCountEl = document.getElementById('totalUserCount'), realUserCountEl = document.getElementById('realUserCount'), botUserCountEl = document.getElementById('botUserCount'), systemStatus = document.getElementById('systemStatus');
        const memoryUsageTextEl = document.getElementById('memoryUsageText'), memoryProgressBarEl = document.getElementById('memoryProgressBar'), memoryWarningEl = document.getElementById('memoryWarning');
        const locationContent = document.getElementById('locationContent'), locationPlaceholder = document.getElementById('locationPlaceholder'), latitudeEl = document.getElementById('latitude'), longitudeEl = document.getElementById('longitude'), accuracyEl = document.getElementById('accuracy'), mapLink = document.getElementById('mapLink');
        const connectionIcon = document.getElementById('connectionIcon'), connectionType = document.getElementById('connectionType'), effectiveType = document.getElementById('effectiveType'), downlink = document.getElementById('downlink'), pingResult = document.getElementById('pingResult'), pingButton = document.getElementById('pingButton');
        const scanBluetoothButton = document.getElementById('scanBluetoothButton'), bluetoothList = document.getElementById('bluetoothList');
        const scanNfcButton = document.getElementById('scanNfcButton'), nfcStatus = document.getElementById('nfcStatus'), nfcContent = document.getElementById('nfcContent');
        
        // --- Constants & State ---
        const MEMORY_LIMIT_MB = 1048576; // 1 TB
        const BOT_BASE_COUNT = 300;
        let db, auth;
        let realUserCount = 0;
        let simulatedBotCount = BOT_BASE_COUNT;
        const sessionId = crypto.randomUUID();
        let heartbeatInterval;

        // --- Gimmick: Memory & Lag ---
        function setupMemoryManager() { const today=new Date().toISOString().split('T')[0];let d=JSON.parse(localStorage.getItem('lanaMemory_v10'))||{};if(d.date!==today){d={date:today,usage:0};localStorage.setItem('lanaMemory_v10',JSON.stringify(d));}updateMemoryUI(); }
        function consumeMemory(amountMB) { let d=JSON.parse(localStorage.getItem('lanaMemory_v10'));d.usage+=amountMB;localStorage.setItem('lanaMemory_v10',JSON.stringify(d));updateMemoryUI(); }
        function getMemoryUsage() { return(JSON.parse(localStorage.getItem('lanaMemory_v10'))||{usage:0}).usage; }
        function formatBytes(mb){if(mb===0)return'0 MB';const gb=mb/1024;const tb=gb/1024;if(tb>=1)return tb.toFixed(2)+' TB';if(gb>=1)return gb.toFixed(1)+' GB';return mb+' MB';}
        function updateMemoryUI() { const u=getMemoryUsage();const p=Math.min((u/MEMORY_LIMIT_MB)*100,100);memoryUsageTextEl.textContent=`${formatBytes(u)} / 1.0 TB`;memoryProgressBarEl.style.width=`${p}%`;if(p>=80){memoryProgressBarEl.style.background='linear-gradient(90deg, #f97316, #ef4444)';memoryWarningEl.classList.remove('hidden');}}
        async function simulateLag() { if (getMemoryUsage() >= MEMORY_LIMIT_MB) { const end = Date.now() + 300; while (Date.now() < end) {} } }
        
        // --- Realtime: Bot & User Count ---
        function startBotSimulator() { updateTotalUsersUI(); setInterval(() => { simulatedBotCount = BOT_BASE_COUNT + Math.floor(Math.random()*11)-5; updateTotalUsersUI(); }, 3000); }
        function updateTotalUsersUI() { botUserCountEl.textContent = simulatedBotCount; realUserCountEl.textContent = realUserCount > 0 ? realUserCount : 'N/A'; totalUserCountEl.textContent = realUserCount > 0 ? realUserCount + simulatedBotCount : simulatedBotCount; }

        // --- Heartbeat Presence System ---
        function setupPresenceSystem(db) {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const presenceCollection = collection(db, 'artifacts', appId, 'public', 'data', 'presence_v10');
            const userDocRef = doc(presenceCollection, sessionId);
            const sendHeartbeat = () => setDoc(userDocRef, { lastSeen: serverTimestamp() }, { merge: true }).catch(err => console.error("Heartbeat failed:", err));
            sendHeartbeat();
            heartbeatInterval = setInterval(sendHeartbeat, 15000);
            window.addEventListener('beforeunload', () => { clearInterval(heartbeatInterval); deleteDoc(userDocRef); });
            onSnapshot(presenceCollection, (snapshot) => {
                const now = Date.now();
                let activeUsers = 0;
                snapshot.docs.forEach(doc => { if (now - (doc.data().lastSeen?.toMillis() || 0) < 30000) activeUsers++; });
                realUserCount = activeUsers;
                updateTotalUsersUI();
            }, (error) => { console.error("Presence snapshot error:", error); realUserCount=0; updateTotalUsersUI(); });
        }
        
        // --- Firebase Initialization (Now Optional) ---
        async function initializeFirebase() {
            try {
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "DEMO_ONLY" };
                if (firebaseConfig.apiKey === "DEMO_ONLY") throw new Error("Konfigurasi server tidak ditemukan.");
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await signInAnonymously(auth);
                systemStatus.innerHTML = `<i class="fas fa-check-circle mr-2 text-green-500"></i><span>Layanan monitoring online terhubung.</span>`;
                setupPresenceSystem(db);
            } catch (error) {
                systemStatus.innerHTML = `<i class="fas fa-exclamation-triangle mr-2 text-yellow-500"></i><span>Layanan monitoring online gagal: ${error.message}</span>`;
                realUserCount = 0;
                updateTotalUsersUI();
            }
        }
        
        // --- Core Functional Features ---
        async function performAction(costMB, actionFn, ...args) { await simulateLag(); consumeMemory(costMB); try { await actionFn(...args); } catch (error) { console.error(`Action failed: ${actionFn.name}`, error); } }
        function setupGeolocation() { if(!navigator.geolocation){locationPlaceholder.textContent='Geolocation tidak didukung.';return;}navigator.geolocation.watchPosition(p=>{locationPlaceholder.classList.add('hidden');locationContent.classList.remove('hidden');const{latitude,longitude,accuracy}=p.coords;latitudeEl.textContent=latitude.toFixed(6);longitudeEl.textContent=longitude.toFixed(6);accuracyEl.textContent=`${Math.round(accuracy)}m`;mapLink.href=`https://www.google.com/maps?q=${latitude},${longitude}`;},()=>{locationPlaceholder.innerHTML=`<span class="text-yellow-400"><i class="fas fa-ban mr-2"></i>Akses lokasi ditolak.</span>`;},{enableHighAccuracy:true});}
        function setupNetworkInfo() { if('connection'in navigator){const u=()=>{const c=navigator.connection;connectionType.textContent=(c.type||'N/A').toUpperCase();const i={'wifi':'fa-wifi','cellular':'fa-signal','ethernet':'fa-ethernet'};connectionIcon.className=`fas ${i[c.type]||'fa-question-circle'}`;effectiveType.textContent=(c.effectiveType||'N/A').toUpperCase();downlink.textContent=c.downlink?c.downlink.toFixed(1):'-';};u();navigator.connection.addEventListener('change',u);}}
        async function measurePing() { pingButton.disabled = true; pingResult.innerHTML = '<div class="spinner mx-auto"></div>'; try { const start = performance.now(); await fetch('https://1.1.1.1/', { method: 'HEAD', mode: 'no-cors', cache: 'no-store' }); pingResult.textContent = `${Math.round(performance.now() - start)} ms`; } catch (e) { pingResult.textContent = 'Error'; } finally { pingButton.disabled = false; } }
        async function scanBluetoothDevices() { try { const device = await navigator.bluetooth.requestDevice({ acceptAllDevices: true }); const li = document.createElement('li'); li.className = 'flex items-center p-3 bg-stone-800 rounded-lg'; li.innerHTML = `<i class="fas fa-mobile-alt fa-lg mr-4 text-stone-400"></i><div><div class="font-semibold text-white">${device.name||'Tanpa Nama'}</div><div class="text-xs text-stone-500 font-mono">${device.id}</div></div>`; bluetoothList.prepend(li); } catch (err) { if(err.name !== 'NotFoundError') console.error('BT Error:', err); } }
        async function scanNfcTag() { try { const ndef = new NDEFReader(); await ndef.scan(); nfcStatus.textContent = 'Siap memindai... Dekatkan tag NFC.'; nfcStatus.classList.remove('hidden'); nfcContent.classList.add('hidden'); ndef.onreading = ({ message, serialNumber }) => { nfcStatus.textContent = `Tag Ditemukan! (Serial: ${serialNumber||'N/A'})`; nfcContent.innerHTML = ''; message.records.forEach(r => { const text = new TextDecoder().decode(r.data); nfcContent.innerHTML += `<div><strong class="text-indigo-300">${r.recordType}:</strong> ${text}</div>`; }); nfcContent.classList.remove('hidden'); }; } catch (error) { nfcStatus.textContent = `Error: ${error.message}`; nfcStatus.classList.remove('hidden'); } }
        function setupFeatureSupport() { if (!navigator.bluetooth) { scanBluetoothButton.disabled = true; scanBluetoothButton.textContent = 'Tidak Didukung'; } if (!('NDEFReader' in window)) { scanNfcButton.disabled = true; scanNfcButton.innerHTML = '<i class="fas fa-ban mr-2"></i>Tidak Didukung'; } }

        // --- App Initialization ---
        async function startApp() {
            consentModal.style.display = 'none';
            appContent.classList.remove('hidden');
            
            // Initialize local features immediately
            setupMemoryManager();
            startBotSimulator();
            setupNetworkInfo();
            setupFeatureSupport();
            setupGeolocation();
            
            // Assign listeners
            pingButton.addEventListener('click', () => performAction(25, measurePing));
            scanBluetoothButton.addEventListener('click', () => performAction(150, scanBluetoothDevices));
            scanNfcButton.addEventListener('click', () => performAction(75, scanNfcTag));
            
            // Attempt to connect to online services (optional)
            await initializeFirebase();
        }

        agreeButton.addEventListener('click', startApp);
        declineButton.addEventListener('click', () => { document.body.innerHTML = `<div class="h-screen flex items-center justify-center text-yellow-300 p-8 text-center">Akses ditolak.</div>`; });

    </script>
</body>
</html>

