<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iot Lana Project v.0.3 (Secure)</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #e5e7eb; }
        .card { background-color: #1f2937; border: 1px solid #374151; border-radius: 0.75rem; padding: 1.5rem; }
        .scan-button { background: linear-gradient(90deg, #3b82f6, #6366f1); transition: all 0.3s ease; box-shadow: 0 4px 15px 0 rgba(99, 102, 241, 0.75); }
        .scan-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px 0 rgba(99, 102, 241, 0.85); }
        .scan-button:disabled { background: #4b5563; color: #9ca3af; cursor: not-allowed; box-shadow: none; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid #6366f1; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .list-item { border-bottom: 1px solid #374151; }
        .list-item:last-child { border-bottom: none; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(17, 24, 39, 0.8); display: flex; justify-content: center; align-items: center; z-index: 50; backdrop-filter: blur(4px); }
        .modal-content { background-color: #1f2937; padding: 2rem; border-radius: 0.75rem; max-width: 500px; width: 90%; border: 1px solid #4b5563; }
    </style>
</head>
<body class="antialiased">

    <!-- Consent Modal is unchanged -->
    <div id="consentModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4 text-white">Persetujuan & Kebijakan Privasi</h2>
            <p class="text-gray-300 mb-6">Untuk berfungsi, aplikasi ini memerlukan izin Anda untuk mengakses informasi koneksi jaringan dan memindai perangkat Bluetooth di sekitar. Kami menghargai privasi Anda dan tidak akan menyimpan atau membagikan data ini.</p>
            <div class="flex justify-end gap-4">
                <button id="declineButton" class="px-4 py-2 rounded-md text-gray-300 bg-gray-600 hover:bg-gray-700">Tolak</button>
                <button id="agreeButton" class="px-4 py-2 rounded-md text-white font-semibold bg-blue-600 hover:bg-blue-700">Setuju & Lanjutkan</button>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">IoT Lana Project <span class="text-sm font-mono bg-green-500 text-white rounded-md px-2 py-1">v.0.3</span></h1>
            <p class="text-gray-400">Antarmuka untuk memindai dan mendeteksi perangkat di sekitar Anda.</p>
        </header>

        <div class="text-center mb-8">
            <button id="scanButton" class="scan-button text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg" disabled>
                <i class="fas fa-search mr-2"></i>Mulai Pemindaian Lingkungan
            </button>
        </div>

        <div id="statusMessage" class="text-center mb-6 hidden"></div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="card">
                <h2 class="text-xl font-semibold text-white mb-4 flex items-center"><i class="fas fa-wifi text-blue-400 mr-3"></i>Informasi Koneksi</h2>
                <ul id="wifiList"></ul>
                <p id="wifiPlaceholder" class="text-gray-500 text-center py-4">Tunggu persetujuan pengguna...</p>
            </div>
            <div class="card">
                <h2 class="text-xl font-semibold text-white mb-4 flex items-center"><i class="fab fa-bluetooth-b text-blue-400 mr-3"></i>Perangkat Bluetooth</h2>
                <div id="bluetoothLoader" class="flex justify-center items-center py-4 hidden">
                    <div class="spinner"></div><span class="ml-3 text-gray-300">Menunggu izin...</span>
                </div>
                <ul id="bluetoothList"></ul>
                <p id="bluetoothPlaceholder" class="text-gray-500 text-center py-4">Tunggu persetujuan pengguna...</p>
                 <div id="bluetooth-notice" class="hidden mt-4 text-xs text-yellow-400 border-t border-gray-700 pt-2"></div>
            </div>
        </div>
    </div>

    <script>
        const consentModal = document.getElementById('consentModal');
        const agreeButton = document.getElementById('agreeButton');
        const declineButton = document.getElementById('declineButton');
        const scanButton = document.getElementById('scanButton');
        const wifiList = document.getElementById('wifiList');
        const bluetoothList = document.getElementById('bluetoothList');
        const statusMessage = document.getElementById('statusMessage');
        const bluetoothLoader = document.getElementById('bluetoothLoader');
        const wifiPlaceholder = document.getElementById('wifiPlaceholder');
        const bluetoothPlaceholder = document.getElementById('bluetoothPlaceholder');
        const bluetoothNotice = document.getElementById('bluetooth-notice');

        // --- Core Application Logic ---
        function initializeApp() {
            consentModal.style.display = 'none';
            wifiPlaceholder.textContent = 'Klik tombol pindai untuk memulai.';
            
            // Check for secure context for Bluetooth
            if (!window.isSecureContext) {
                scanButton.disabled = true;
                scanButton.textContent = 'HTTPS Diperlukan';
                bluetoothPlaceholder.textContent = 'Fitur tidak tersedia.';
                showBluetoothNotice('Untuk keamanan, pemindaian Bluetooth hanya berfungsi di halaman yang aman (HTTPS) atau localhost.', 'error');
                return;
            }

            // Check if Bluetooth API is supported at all
            if (!navigator.bluetooth) {
                scanButton.disabled = true;
                bluetoothPlaceholder.textContent = 'API tidak didukung.';
                showBluetoothNotice('Web Bluetooth API tidak didukung di browser ini. Coba Google Chrome atau Microsoft Edge.', 'error');
                return;
            }

            scanButton.disabled = false;
            bluetoothPlaceholder.textContent = 'Klik tombol pindai untuk memulai.';
        }

        agreeButton.addEventListener('click', initializeApp);
        declineButton.addEventListener('click', () => {
             document.body.innerHTML = `<div class="h-screen flex items-center justify-center text-yellow-300">Akses ditolak. Muat ulang halaman untuk menyetujui.</div>`;
        });
        
        scanButton.addEventListener('click', () => {
            wifiList.innerHTML = '';
            bluetoothList.innerHTML = '';
            statusMessage.classList.add('hidden');
            wifiPlaceholder.classList.add('hidden');
            bluetoothPlaceholder.classList.add('hidden');

            getConnectedWifiInfo();
            scanBluetoothDevices();
        });

        function getConnectedWifiInfo() {
            // This function remains the same as it doesn't require a secure context.
            // (Implementation from v.0.2)
            if ('connection' in navigator) {
                const connection = navigator.connection;
                const info = {
                    'Tipe Efektif': connection.effectiveType.toUpperCase(),
                    'Kecepatan Downlink': `${connection.downlink} Mbps`,
                    'Tipe Koneksi': connection.type || 'Tidak Diketahui',
                };
                Object.entries(info).forEach(([key, value]) => {
                     const listItem = document.createElement('li');
                     listItem.className = 'list-item flex justify-between items-center p-3';
                     listItem.innerHTML = `<span class="text-gray-400">${key}</span><span class="font-medium">${value}</span>`;
                     wifiList.appendChild(listItem);
                });
            } else {
                 wifiPlaceholder.textContent = 'Network Information API tidak didukung.';
                 wifiPlaceholder.classList.remove('hidden');
            }
        }
        
        async function scanBluetoothDevices() {
            bluetoothLoader.classList.remove('hidden');
            updateStatus('Silakan pilih perangkat dari dialog yang muncul di browser Anda.', 'info');

            try {
                const device = await navigator.bluetooth.requestDevice({ acceptAllDevices: true });
                updateStatus(`Berhasil menemukan: ${device.name || `ID: ${device.id}`}`, 'success');
                const listItem = document.createElement('li');
                listItem.className = 'list-item flex items-center p-3';
                listItem.innerHTML = `<i class="fas fa-mobile-alt mr-3 text-gray-400"></i><div><div class="font-semibold">${device.name || 'Perangkat Tanpa Nama'}</div><div class="text-xs text-gray-500">${device.id}</div></div>`;
                bluetoothList.appendChild(listItem);

            } catch (error) {
                console.error('Bluetooth Scan Error:', error.name, error.message);
                if (error.name === 'NotFoundError') {
                    updateStatus('Pemindaian dibatalkan atau tidak ada perangkat yang dipilih.', 'warn');
                    bluetoothPlaceholder.innerText = 'Tidak ada perangkat yang dipilih.';
                    bluetoothPlaceholder.classList.remove('hidden');
                } else if (error.name === 'SecurityError') {
                    updateStatus('Akses diblokir karena halaman tidak aman (bukan HTTPS).', 'error');
                    bluetoothPlaceholder.innerText = 'Konteks tidak aman.';
                    bluetoothPlaceholder.classList.remove('hidden');
                } else {
                    updateStatus(`Terjadi kesalahan: ${error.message}`, 'error');
                    bluetoothPlaceholder.innerText = 'Terjadi kesalahan.';
                    bluetoothPlaceholder.classList.remove('hidden');
                }
            } finally {
                 bluetoothLoader.classList.add('hidden');
            }
        }
        
        function showBluetoothNotice(message, type) {
            bluetoothNotice.textContent = message;
            bluetoothNotice.className = 'mt-4 text-xs border-t border-gray-700 pt-2';
            bluetoothNotice.classList.add(type === 'error' ? 'text-red-400' : 'text-yellow-400');
            bluetoothNotice.classList.remove('hidden');
        }
        
        function updateStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = 'text-center mb-6 p-2 rounded-md font-medium ';
            switch(type) {
                case 'error': statusMessage.classList.add('bg-red-900', 'text-red-300'); break;
                case 'success': statusMessage.classList.add('bg-green-900', 'text-green-300'); break;
                case 'warn': statusMessage.classList.add('bg-yellow-900', 'text-yellow-300'); break;
                default: statusMessage.classList.add('bg-blue-900', 'text-blue-300');
            }
            statusMessage.classList.remove('hidden');
            setTimeout(() => { statusMessage.classList.add('hidden'); }, 6000);
        }
    </script>
</body>
</html>

