<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iot Lana Project v.0.5 (Geolocation)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0c0a09; color: #e7e5e4; }
        .card { background-color: #1c1917; border: 1px solid #44403c; border-radius: 0.75rem; padding: 1.5rem; }
        .action-button { background: linear-gradient(90deg, #3b82f6, #6366f1); transition: all 0.3s ease; box-shadow: 0 4px 15px 0 rgba(99, 102, 241, 0.5); }
        .action-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px 0 rgba(99, 102, 241, 0.6); }
        .action-button:disabled { background: #57534e; color: #a8a29e; cursor: not-allowed; box-shadow: none; }
        .spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 3px solid #6366f1; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(12, 10, 9, 0.8); display: flex; justify-content: center; align-items: center; z-index: 50; backdrop-filter: blur(8px); }
        .modal-content { background-color: #1c1917; padding: 2rem; border-radius: 0.75rem; max-width: 500px; width: 90%; border: 1px solid #57534e; }
    </style>
</head>
<body class="antialiased">

    <!-- Consent Modal -->
    <div id="consentModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4 text-white">Izin Akses Diperlukan</h2>
            <p class="text-stone-300 mb-6">Aplikasi ini memerlukan izin untuk mengakses **informasi jaringan, lokasi (GPS), dan Bluetooth** untuk berfungsi sepenuhnya. Data Anda diproses di perangkat Anda dan tidak disimpan.</p>
            <div class="flex justify-end gap-4">
                <button id="declineButton" class="px-5 py-2 rounded-md text-stone-300 bg-stone-600 hover:bg-stone-700 font-semibold">Tolak</button>
                <button id="agreeButton" class="px-5 py-2 rounded-md text-white font-semibold bg-blue-600 hover:bg-blue-700">Setuju & Lanjutkan</button>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-extrabold text-white mb-2">IoT Lana Dashboard <span class="text-lg align-middle font-mono bg-green-600 text-white rounded-md px-2 py-1">v.0.5</span></h1>
            <p class="text-stone-400">Analisis Real-Time: Koneksi, Lokasi, dan Perangkat Sekitar</p>
        </header>

        <div id="app-content" class="hidden space-y-8">
            
            <!-- Location Card -->
            <div class="card">
                 <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                    <i class="fas fa-location-arrow text-green-400 mr-3"></i>Lokasi Real-Time
                </h2>
                <div id="locationContent" class="hidden grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                    <div>
                        <div class="text-stone-400 text-sm font-medium">Latitude</div>
                        <div id="latitude" class="text-lg font-bold text-white">-</div>
                    </div>
                    <div>
                        <div class="text-stone-400 text-sm font-medium">Longitude</div>
                        <div id="longitude" class="text-lg font-bold text-white">-</div>
                    </div>
                    <div>
                        <div class="text-stone-400 text-sm font-medium">Akurasi</div>
                        <div id="accuracy" class="text-lg font-bold text-white">-</div>
                    </div>
                    <div class="sm:col-span-3 mt-4">
                         <a id="mapLink" href="#" target="_blank" rel="noopener noreferrer" class="inline-block w-full sm:w-auto bg-green-600 hover:bg-green-500 text-white font-semibold py-2 px-6 rounded-lg text-center">
                            <i class="fas fa-map-marker-alt mr-2"></i>Buka di Peta
                        </a>
                    </div>
                </div>
                <div id="locationPlaceholder" class="flex items-center justify-center py-4">
                    <div class="spinner"></div>
                    <span class="ml-3 text-stone-300">Meminta izin dan mencari lokasi...</span>
                </div>
            </div>

            <!-- Network & Ping Card -->
            <div class="card grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="text-center md:border-r border-stone-700 p-2">
                    <div class="text-stone-400 text-sm font-medium mb-2">Tipe Koneksi</div>
                    <div class="text-2xl font-bold text-white flex items-center justify-center gap-2">
                        <i id="connectionIcon" class="fas fa-wifi"></i>
                        <span id="connectionType">WIFI</span>
                    </div>
                </div>
                <div class="text-center md:border-r border-stone-700 p-2">
                    <div class="text-stone-400 text-sm font-medium mb-2">Kualitas Jaringan</div>
                    <div id="effectiveType" class="text-2xl font-bold text-cyan-400">4G</div>
                </div>
                <div class="text-center md:border-r border-stone-700 p-2">
                    <div class="text-stone-400 text-sm font-medium mb-2">Est. Downlink</div>
                    <div class="text-2xl font-bold text-white"><span id="downlink">10.0</span> <span class="text-lg text-stone-400">Mbps</span></div>
                </div>
                <div class="text-center p-2 flex flex-col items-center justify-center">
                    <div class="text-stone-400 text-sm font-medium mb-2">Uji Latensi (Ping)</div>
                    <div id="pingResult" class="text-2xl font-bold text-amber-400 mb-3">- ms</div>
                    <button id="pingButton" class="w-full bg-stone-600 hover:bg-stone-500 text-white font-semibold py-2 px-4 rounded-lg text-sm">
                        <i class="fas fa-play mr-1"></i> Mulai Tes
                    </button>
                </div>
            </div>

            <!-- Bluetooth Card -->
            <div class="card">
                <h2 class="text-xl font-semibold text-white mb-4 flex items-center">
                    <i class="fab fa-bluetooth-b text-blue-400 mr-3"></i>Pemindai Perangkat Bluetooth
                </h2>
                <button id="scanBluetoothButton" class="action-button text-white font-bold py-2 px-5 rounded-lg">
                    <i class="fas fa-search mr-2"></i>Cari Perangkat
                </button>
                <div id="bluetooth-notice" class="hidden mt-4 text-xs text-yellow-400"></div>
                <ul id="bluetoothList" class="mt-4 space-y-2"></ul>
                <p id="bluetoothPlaceholder" class="hidden text-stone-500 text-center py-4">Belum ada perangkat yang ditemukan.</p>
            </div>
        </div>

        <div id="insecure-context-warning" class="hidden text-center card bg-red-900 border-red-700">
            <h2 class="text-xl font-bold text-white"><i class="fas fa-shield-halved mr-2"></i>Koneksi Tidak Aman</h2>
            <p class="text-red-200 mt-2">Untuk keamanan, fitur canggih seperti Bluetooth dan GPS hanya berfungsi pada halaman aman (HTTPS).</p>
        </div>
    </div>

    <script>
        // --- Element References ---
        const consentModal = document.getElementById('consentModal');
        const agreeButton = document.getElementById('agreeButton');
        const declineButton = document.getElementById('declineButton');
        const appContent = document.getElementById('app-content');
        const insecureContextWarning = document.getElementById('insecure-context-warning');

        // Location Card
        const locationContent = document.getElementById('locationContent');
        const locationPlaceholder = document.getElementById('locationPlaceholder');
        const latitudeEl = document.getElementById('latitude');
        const longitudeEl = document.getElementById('longitude');
        const accuracyEl = document.getElementById('accuracy');
        const mapLink = document.getElementById('mapLink');
        
        // Network Card (as before)
        const connectionIcon = document.getElementById('connectionIcon'), connectionType = document.getElementById('connectionType'), effectiveType = document.getElementById('effectiveType'), downlink = document.getElementById('downlink'), pingResult = document.getElementById('pingResult'), pingButton = document.getElementById('pingButton');
        
        // Bluetooth Card (as before)
        const scanBluetoothButton = document.getElementById('scanBluetoothButton'), bluetoothNotice = document.getElementById('bluetooth-notice'), bluetoothList = document.getElementById('bluetoothList'), bluetoothPlaceholder = document.getElementById('bluetoothPlaceholder');
        
        // --- App Initialization ---
        function initializeApp() {
            consentModal.style.display = 'none';
            if (!window.isSecureContext) {
                insecureContextWarning.classList.remove('hidden');
                return;
            }
            appContent.classList.remove('hidden');

            setupGeolocation(); // Start location tracking first
            setupNetworkInfo();
            setupBluetooth();
            pingButton.addEventListener('click', measurePing);
        }

        // --- Geolocation Logic ---
        function setupGeolocation() {
            if (!navigator.geolocation) {
                locationPlaceholder.textContent = 'Geolocation tidak didukung di browser ini.';
                return;
            }
            
            const geoOptions = {
                enableHighAccuracy: true, // Request the most accurate location possible
                timeout: 10000,           // Timeout after 10 seconds
                maximumAge: 0             // Don't use a cached position
            };

            navigator.geolocation.watchPosition(handleLocationSuccess, handleLocationError, geoOptions);
        }

        function handleLocationSuccess(position) {
            locationPlaceholder.classList.add('hidden');
            locationContent.classList.remove('hidden');

            const { latitude, longitude, accuracy } = position.coords;

            latitudeEl.textContent = latitude.toFixed(6);
            longitudeEl.textContent = longitude.toFixed(6);
            accuracyEl.textContent = `${Math.round(accuracy)} meter`;
            
            mapLink.href = `https://www.google.com/maps?q=${latitude},${longitude}`;
        }

        function handleLocationError(error) {
            locationContent.classList.add('hidden');
            locationPlaceholder.classList.remove('hidden');
            locationPlaceholder.innerHTML = ''; // Clear spinner
            
            let message = '';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = '<i class="fas fa-ban mr-2 text-red-400"></i> Akses lokasi ditolak oleh pengguna.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = 'Informasi lokasi tidak tersedia saat ini.';
                    break;
                case error.TIMEOUT:
                    message = 'Waktu permintaan lokasi habis.';
                    break;
                default:
                    message = 'Terjadi kesalahan yang tidak diketahui.';
                    break;
            }
            locationPlaceholder.innerHTML = `<span class="text-yellow-400">${message}</span>`;
        }

        // --- Network & Ping Logic (Unchanged from v.0.4) ---
        function setupNetworkInfo() { if ('connection' in navigator) { updateNetworkStatus(); navigator.connection.addEventListener('change', updateNetworkStatus); } }
        function updateNetworkStatus() { const conn = navigator.connection; const type = conn.type || 'unknown'; connectionType.textContent = type.toUpperCase(); const icons = {'wifi': 'fa-wifi', 'cellular': 'fa-signal', 'ethernet': 'fa-ethernet', 'unknown': 'fa-question-circle'}; connectionIcon.className = `fas ${icons[type] || icons['unknown']}`; effectiveType.textContent = conn.effectiveType.toUpperCase() || 'N/A'; downlink.textContent = conn.downlink ? conn.downlink.toFixed(1) : 'N/A'; }
        async function measurePing() { pingButton.disabled = true; pingResult.innerHTML = '<div class="spinner mx-auto"></div>'; try { const startTime = performance.now(); await fetch('https://1.1.1.1/', { method: 'HEAD', mode: 'no-cors', cache: 'no-store' }); const endTime = performance.now(); pingResult.textContent = `${Math.round(endTime - startTime)} ms`; } catch (error) { pingResult.textContent = 'Error'; } finally { pingButton.disabled = false; } }

        // --- Bluetooth Logic (Unchanged from v.0.4) ---
        function setupBluetooth() { if (!navigator.bluetooth) { scanBluetoothButton.disabled = true; scanBluetoothButton.textContent = 'Tidak Didukung'; } else { scanBluetoothButton.addEventListener('click', scanBluetoothDevices); } }
        async function scanBluetoothDevices() { scanBluetoothButton.disabled = true; bluetoothList.innerHTML = ''; try { const device = await navigator.bluetooth.requestDevice({ acceptAllDevices: true }); const li = document.createElement('li'); li.className = 'flex items-center p-3 bg-stone-800 rounded-lg'; li.innerHTML = `<i class="fas fa-mobile-alt fa-lg mr-4 text-stone-400"></i><div><div class="font-semibold text-white">${device.name || 'Tanpa Nama'}</div><div class="text-xs text-stone-500 font-mono">${device.id}</div></div>`; bluetoothList.appendChild(li); } catch (error) { if (error.name !== 'NotFoundError') { console.error('Bluetooth Error:', error); } } finally { scanBluetoothButton.disabled = false; } }

        // --- Initial Load ---
        agreeButton.addEventListener('click', initializeApp);
        declineButton.addEventListener('click', () => { document.body.innerHTML = `<div class="h-screen flex items-center justify-center text-yellow-300 p-8 text-center">Akses ditolak. Muat ulang halaman untuk memberikan izin.</div>`; });
    </script>
</body>
</html>

