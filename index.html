<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iot Lana Project v.0.6 (NFC)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0c0a09; color: #e7e5e4; }
        .card { background-color: #1c1917; border: 1px solid #44403c; border-radius: 0.75rem; padding: 1.5rem; }
        .action-button { background: linear-gradient(90deg, #3b82f6, #6366f1); transition: all 0.3s ease; box-shadow: 0 4px 15px 0 rgba(99, 102, 241, 0.5); }
        .action-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px 0 rgba(99, 102, 241, 0.6); }
        .action-button:disabled { background: #57534e; color: #a8a29e; cursor: not-allowed; box-shadow: none; }
        .spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 3px solid #6366f1; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(12, 10, 9, 0.8); display: flex; justify-content: center; align-items: center; z-index: 50; backdrop-filter: blur(8px); }
        .modal-content { background-color: #1c1917; padding: 2rem; border-radius: 0.75rem; max-width: 500px; width: 90%; border: 1px solid #57534e; }
    </style>
</head>
<body class="antialiased">

    <!-- Consent Modal -->
    <div id="consentModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4 text-white">Izin Akses Diperlukan</h2>
            <p class="text-stone-300 mb-6">Aplikasi ini memerlukan izin untuk mengakses **Jaringan, Lokasi, Bluetooth, dan NFC** untuk berfungsi. Data Anda tidak disimpan dan hanya diproses di perangkat Anda.</p>
            <div class="flex justify-end gap-4">
                <button id="declineButton" class="px-5 py-2 rounded-md text-stone-300 bg-stone-600 hover:bg-stone-700 font-semibold">Tolak</button>
                <button id="agreeButton" class="px-5 py-2 rounded-md text-white font-semibold bg-blue-600 hover:bg-blue-700">Setuju</button>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-extrabold text-white mb-2">IoT Lana Dashboard <span class="text-lg align-middle font-mono bg-green-600 text-white rounded-md px-2 py-1">v.0.6</span></h1>
            <p class="text-stone-400">Analisis Real-Time: Koneksi, Lokasi, Perangkat & Tag NFC</p>
        </header>

        <div id="app-content" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <div class="space-y-8">
                <!-- Location Card -->
                <div class="card">
                    <h2 class="text-xl font-semibold text-white mb-4 flex items-center"><i class="fas fa-location-arrow text-green-400 mr-3"></i>Lokasi Real-Time</h2>
                    <div id="locationContent" class="hidden grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                        <div><div class="text-stone-400 text-sm">Latitude</div><div id="latitude" class="text-lg font-bold">-</div></div>
                        <div><div class="text-stone-400 text-sm">Longitude</div><div id="longitude" class="text-lg font-bold">-</div></div>
                        <div><div class="text-stone-400 text-sm">Akurasi</div><div id="accuracy" class="text-lg font-bold">-</div></div>
                        <div class="sm:col-span-3 mt-4">
                            <a id="mapLink" href="#" target="_blank" rel="noopener noreferrer" class="inline-block w-full sm:w-auto bg-green-600 hover:bg-green-500 text-white font-semibold py-2 px-6 rounded-lg text-center"><i class="fas fa-map-marker-alt mr-2"></i>Buka di Peta</a>
                        </div>
                    </div>
                    <div id="locationPlaceholder" class="flex items-center justify-center py-4"><div class="spinner"></div><span class="ml-3 text-stone-300">Mencari lokasi...</span></div>
                </div>

                <!-- Network & Ping Card -->
                <div class="card">
                    <h2 class="text-xl font-semibold text-white mb-4">Analisis Koneksi Aktif</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center"><div class="text-stone-400 text-sm">Tipe</div><div class="text-xl font-bold flex items-center justify-center gap-2"><i id="connectionIcon" class="fas fa-wifi"></i><span id="connectionType"></span></div></div>
                        <div class="text-center"><div class="text-stone-400 text-sm">Kualitas</div><div id="effectiveType" class="text-xl font-bold text-cyan-400"></div></div>
                        <div class="text-center"><div class="text-stone-400 text-sm">Downlink</div><div class="text-xl font-bold"><span id="downlink">-</span> <span class="text-base text-stone-400">Mbps</span></div></div>
                        <div class="text-center"><div class="text-stone-400 text-sm">Ping</div><div id="pingResult" class="text-xl font-bold text-amber-400">- ms</div></div>
                    </div>
                     <button id="pingButton" class="w-full mt-4 bg-stone-600 hover:bg-stone-500 text-white font-semibold py-2 px-4 rounded-lg text-sm"><i class="fas fa-play mr-1"></i> Uji Ulang Ping</button>
                    <p class="mt-4 pt-3 border-t border-stone-700 text-xs text-stone-500"><i class="fas fa-ban mr-1 text-red-500"></i><b>Catatan:</b> Pemindaian Wi-Fi sekitar tidak dimungkinkan di browser karena kebijakan privasi & keamanan. Ini adalah data koneksi Anda saat ini.</p>
                </div>
            </div>

            <div class="space-y-8">
                <!-- Bluetooth Card -->
                <div class="card">
                    <h2 class="text-xl font-semibold text-white mb-4"><i class="fab fa-bluetooth-b text-blue-400 mr-3"></i>Pemindai Bluetooth</h2>
                    <button id="scanBluetoothButton" class="action-button text-white font-bold py-2 px-5 rounded-lg"><i class="fas fa-search mr-2"></i>Cari Perangkat</button>
                    <ul id="bluetoothList" class="mt-4 space-y-2"></ul>
                </div>

                <!-- NFC Card -->
                <div class="card">
                     <h2 class="text-xl font-semibold text-white mb-4"><i class="fas fa-nfc text-indigo-400 mr-3"></i>Pembaca Tag NFC</h2>
                     <button id="scanNfcButton" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-5 rounded-lg"><i class="fas fa-nfc mr-2"></i>Pindai Tag NFC</button>
                     <div id="nfcStatus" class="mt-4 text-center text-stone-400 hidden"></div>
                     <div id="nfcContent" class="mt-4 hidden break-words p-3 bg-stone-800 rounded-lg"></div>
                </div>
            </div>
        </div>
        <div id="insecure-context-warning" class="hidden text-center card bg-red-900 border-red-700">...</div>
    </div>

    <script>
        // --- All Element References ---
        const consentModal = document.getElementById('consentModal'), agreeButton = document.getElementById('agreeButton'), declineButton = document.getElementById('declineButton'), appContent = document.getElementById('app-content'), insecureContextWarning = document.getElementById('insecure-context-warning');
        const locationContent = document.getElementById('locationContent'), locationPlaceholder = document.getElementById('locationPlaceholder'), latitudeEl = document.getElementById('latitude'), longitudeEl = document.getElementById('longitude'), accuracyEl = document.getElementById('accuracy'), mapLink = document.getElementById('mapLink');
        const connectionIcon = document.getElementById('connectionIcon'), connectionType = document.getElementById('connectionType'), effectiveType = document.getElementById('effectiveType'), downlink = document.getElementById('downlink'), pingResult = document.getElementById('pingResult'), pingButton = document.getElementById('pingButton');
        const scanBluetoothButton = document.getElementById('scanBluetoothButton'), bluetoothList = document.getElementById('bluetoothList');
        const scanNfcButton = document.getElementById('scanNfcButton'), nfcStatus = document.getElementById('nfcStatus'), nfcContent = document.getElementById('nfcContent');
        
        // --- App Initialization ---
        function initializeApp() {
            consentModal.style.display = 'none';
            if (!window.isSecureContext) { insecureContextWarning.classList.remove('hidden'); return; }
            appContent.classList.remove('hidden');
            setupGeolocation();
            setupNetworkInfo();
            setupBluetooth();
            setupNFC(); // Initialize NFC
            pingButton.addEventListener('click', measurePing);
        }

        // --- Geolocation, Network, Ping, Bluetooth Logic (Unchanged from v.0.5) ---
        function setupGeolocation() { if (!navigator.geolocation) { locationPlaceholder.textContent = 'Geolocation tidak didukung.'; return; } navigator.geolocation.watchPosition(handleLocationSuccess, handleLocationError, { enableHighAccuracy: true }); }
        function handleLocationSuccess(pos) { locationPlaceholder.classList.add('hidden'); locationContent.classList.remove('hidden'); const { latitude, longitude, accuracy } = pos.coords; latitudeEl.textContent = latitude.toFixed(6); longitudeEl.textContent = longitude.toFixed(6); accuracyEl.textContent = `${Math.round(accuracy)}m`; mapLink.href = `https://www.google.com/maps?q=${latitude},${longitude}`; }
        function handleLocationError(err) { locationPlaceholder.innerHTML = `<span class="text-yellow-400"><i class="fas fa-ban mr-2"></i>Akses lokasi ditolak.</span>`; }
        function setupNetworkInfo() { if ('connection' in navigator) { updateNetworkStatus(); navigator.connection.addEventListener('change', updateNetworkStatus); } }
        function updateNetworkStatus() { const c = navigator.connection; connectionType.textContent = (c.type || 'N/A').toUpperCase(); const i = {'wifi':'fa-wifi','cellular':'fa-signal','ethernet':'fa-ethernet'}; connectionIcon.className=`fas ${i[c.type]||'fa-question-circle'}`; effectiveType.textContent = (c.effectiveType || 'N/A').toUpperCase(); downlink.textContent = c.downlink ? c.downlink.toFixed(1) : '-'; }
        async function measurePing() { pingButton.disabled = true; pingResult.innerHTML = '<div class="spinner mx-auto"></div>'; try { const start = performance.now(); await fetch('https://1.1.1.1/', { method: 'HEAD', mode: 'no-cors', cache: 'no-store' }); pingResult.textContent = `${Math.round(performance.now() - start)} ms`; } catch (e) { pingResult.textContent = 'Error'; } finally { pingButton.disabled = false; } }
        function setupBluetooth() { if (!navigator.bluetooth) { scanBluetoothButton.disabled = true; scanBluetoothButton.textContent = 'Tidak Didukung'; } else { scanBluetoothButton.addEventListener('click', scanBluetoothDevices); } }
        async function scanBluetoothDevices() { try { const device = await navigator.bluetooth.requestDevice({ acceptAllDevices: true }); const li = document.createElement('li'); li.className = 'flex items-center p-3 bg-stone-800 rounded-lg'; li.innerHTML = `<i class="fas fa-mobile-alt fa-lg mr-4 text-stone-400"></i><div><div class="font-semibold text-white">${device.name || 'Tanpa Nama'}</div><div class="text-xs text-stone-500 font-mono">${device.id}</div></div>`; bluetoothList.prepend(li); } catch (err) { if (err.name !== 'NotFoundError') console.error('BT Error:', err); } }

        // --- NEW: NFC Logic ---
        function setupNFC() {
            if ('NDEFReader' in window) {
                scanNfcButton.addEventListener('click', scanNfcTag);
            } else {
                scanNfcButton.disabled = true;
                scanNfcButton.innerHTML = '<i class="fas fa-ban mr-2"></i>NFC Tidak Didukung';
                nfcStatus.textContent = 'Browser Anda tidak mendukung Web NFC. Coba di Chrome pada Android.';
                nfcStatus.classList.remove('hidden');
            }
        }

        async function scanNfcTag() {
            try {
                const ndef = new NDEFReader();
                await ndef.scan();
                
                nfcStatus.textContent = 'Siap memindai... Dekatkan tag NFC ke bagian belakang ponsel Anda.';
                nfcStatus.classList.remove('hidden');
                nfcContent.classList.add('hidden');

                ndef.addEventListener('reading', ({ message, serialNumber }) => {
                    nfcStatus.textContent = `Tag Ditemukan! (Serial: ${serialNumber || 'N/A'})`;
                    nfcContent.innerHTML = ''; // Clear previous content
                    
                    for (const record of message.records) {
                        const textDecoder = new TextDecoder(record.encoding);
                        const text = textDecoder.decode(record.data);
                        
                        const recordEl = document.createElement('div');
                        recordEl.className = 'mb-2';
                        recordEl.innerHTML = `<strong class="text-indigo-300">Tipe:</strong> ${record.recordType}<br><strong class="text-indigo-300">Data:</strong> ${text}`;
                        nfcContent.appendChild(recordEl);
                    }
                    nfcContent.classList.remove('hidden');
                });

                 ndef.addEventListener('readingerror', () => {
                    nfcStatus.textContent = 'Gagal membaca tag NFC. Silakan coba lagi.';
                });

            } catch (error) {
                console.error('NFC Error:', error);
                nfcStatus.textContent = `Error: ${error.message}`;
                nfcStatus.classList.remove('hidden');
            }
        }

        // --- Initial Load ---
        agreeButton.addEventListener('click', initializeApp);
        declineButton.addEventListener('click', () => { document.body.innerHTML = `<div class="h-screen flex items-center justify-center text-yellow-300 p-8 text-center">Akses ditolak.</div>`; });
    </script>
</body>
</html>

